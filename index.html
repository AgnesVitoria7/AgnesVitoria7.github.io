<!-- ... (todo o seu HTML acima permanece igual até a função carregarHorarios) -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAAmyAjY--9e23VUdpqGoLyCx_N1hTYyq8",
    authDomain: "espaco-bela-flor.firebaseapp.com",
    projectId: "espaco-bela-flor",
    storageBucket: "espaco-bela-flor.appspot.com",
    messagingSenderId: "1073820568560",
    appId: "1:1073820568560:web:c8d47db51411b44b66ab35"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const form = document.getElementById("form-agendamento");
  const selectHora = document.getElementById("hora");
  const inputData = document.getElementById("data");

  function gerarHorariosFixos() {
    const horarios = [];
    for (let hora = 7; hora <= 18; hora++) {
      horarios.push(hora.toString().padStart(2, '0') + ":00");
    }
    return horarios;
  }

  async function carregarHorarios(dataSelecionada = null) {
    const horariosFixos = gerarHorariosFixos();
    selectHora.innerHTML = "<option value=''>Selecione um horário</option>";

    let agendamentos = [];
    if (dataSelecionada) {
      try {
        const q = query(collection(db, "agendamentos"), where("data", "==", dataSelecionada));
        const querySnapshot = await getDocs(q);
        agendamentos = querySnapshot.docs.map(doc => doc.data());
      } catch (error) {
        console.error("Erro ao buscar agendamentos: ", error);
      }
    }

    const servicoSelecionado = document.getElementById("servico").value;

    horariosFixos.forEach((hora, i) => {
      const option = document.createElement("option");
      option.value = hora;
      option.textContent = hora;

      const proximaHora = horariosFixos[i + 1];

      const ocupado = agendamentos.some(a => a.hora === hora);
      const proximoOcupado = agendamentos.some(a => a.hora === proximaHora);

      // Bloqueio do horário e do próximo se for "manicure-pedicure"
      const indisponivel =
        ocupado ||
        (servicoSelecionado === "manicure-pedicure" && proximoOcupado) ||
        (servicoSelecionado === "manicure-pedicure" && i === horariosFixos.length - 1); // Último horário não tem próximo

      if (indisponivel) {
        option.disabled = true;
        option.textContent += " (indisponível)";
        option.style.color = "#aaa";
      }

      selectHora.appendChild(option);
    });
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const nome = document.getElementById("nome").value.trim();
    const data = inputData.value;
    const hora = selectHora.value;
    const servico = document.getElementById("servico").value;
    const contato = document.getElementById("contato").value.trim();

    if (!data || !hora) {
      alert("Por favor, selecione uma data e horário disponíveis.");
      return;
    }

    const horariosFixos = gerarHorariosFixos();
    const horaIndex = horariosFixos.indexOf(hora);
    const proximaHora = horariosFixos[horaIndex + 1];

    try {
      const q = query(collection(db, "agendamentos"), where("data", "==", data));
      const querySnapshot = await getDocs(q);
      const agendados = querySnapshot.docs.map(doc => doc.data());

      const jaAgendado = agendados.some(a =>
        a.hora === hora || (servico === "manicure-pedicure" && a.hora === proximaHora)
      );

      if (jaAgendado) {
        alert("⚠️ Este horário (ou o seguinte) já está ocupado.");
        return;
      }

      await addDoc(collection(db, "agendamentos"), {
        nome,
        data,
        hora,
        servico,
        contato,
        criadoEm: Timestamp.now()
      });

      document.getElementById("mensagem-sucesso").classList.remove("oculto");
      form.reset();
      selectHora.disabled = true;
      carregarHorarios(data);
    } catch (error) {
      console.error("Erro ao salvar agendamento: ", error);
      alert("Erro ao salvar agendamento. Tente novamente mais tarde.");
    }
  });

  inputData.addEventListener("change", (e) => {
    selectHora.disabled = false;
    carregarHorarios(e.target.value);
  });

  document.getElementById("servico").addEventListener("change", () => {
    const data = inputData.value;
    if (data) carregarHorarios(data);
  });

  window.onload = () => {
    inputData.value = "";
    selectHora.innerHTML = "<option value=''>Selecione uma data primeiro</option>";
    selectHora.disabled = true;
  };

  document.getElementById("btn-acessar").addEventListener("click", function (event) {
    event.preventDefault();
    const senha = prompt("Digite a senha de acesso:");
    if (senha === "1425") {
      window.location.href = "agendamentos.html";
    } else {
      alert("❌ Senha incorreta. Acesso negado.");
    }
  });
</script>
